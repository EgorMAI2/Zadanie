import numpy as np
from scipy.special import spherical_jn, spherical_yn
import matplotlib.pyplot as plt
import json


class RadarCrossSectionCalculator:
    def __init__(self, diameter):
        self.diameter = diameter
        self.radius = diameter / 2

    def calculate_epr(self, frequency):
        # Основные константы
        speed_of_light = 3e8  # скорость света
        wavelength = speed_of_light / frequency  # длина волны
        k = 2 * np.pi / wavelength  # волновое число

        N = int(np.ceil(k * self.radius + 4.05)) 
        # Суммы по рядам для A_n и B_n
        an_sum = 0
        bn_sum = 0

        # Итерации по порядку функций Бесселя
        for n in range(N):
            kr = k * self.radius  # аргумент функций Бесселя
            jn_kr = spherical_jn(n, kr)  # сферическая функция Бесселя
            hn_kr = spherical_jn(n, kr) + 1j * spherical_yn(n, kr)  # сферическая функция Ганкеля

            # Коэффициент B_n
            if n > 0:
                jn_minus1 = spherical_jn(n-1, kr)
                hn_minus1 = spherical_jn(n-1, kr) + 1j * spherical_yn(n-1, kr)
                numerator_bn = kr * jn_minus1 - n * jn_kr
                denominator_bn = kr * hn_minus1 - n * hn_kr
                bn = numerator_bn / denominator_bn
            else:
                bn = 0

            # Коэффициент A_n
            an = jn_kr / hn_kr

            # Сумма для рядов
            term = (-1)**n * (n + 0.5) * (bn - an)
            an_sum += term.real
            bn_sum += term.imag

        # значение ЭПР
        epr_value = ((wavelength ** 2) / np.pi) * abs(an_sum + 1j * bn_sum) ** 2
        return epr_value


class Plotter:
    def plot_epr_frequency(self, frequencies, ep_values, filename):
        plt.figure(figsize=(10, 6))
        plt.semilogx(frequencies, ep_values, label="ЭПР")
        plt.xlabel("Частота, Гц")
        plt.ylabel("ЭПР, м²")
        plt.title("Зависимость ЭПР от частоты")
        plt.grid(True)
        plt.legend()
        plt.savefig(filename)
        print("График успешно сохранён:", filename)

def main():
    # Заданные параметры
    D = 30e-3  # диаметр сферы
    fmin = 0.01e9  # минимальная частота
    fmax = 25e9  # максимальная частота
    num_points = 100  # количество точек для графика

    calculator = RadarCrossSectionCalculator(D)

    frequencies = np.logspace(np.log10(fmin), np.log10(fmax), num_points)
    data_list = []

    # Расчёт ЭПР для каждой частоты
    for freq in frequencies:
        epr_value = calculator.calculate_epr(freq)
        wavelength = 3e8 / freq  # λ = c/freq
        data_point = {
            "freq": freq,
            "lambda": wavelength,
            "rcs": epr_value
        }
        data_list.append(data_point)

    # Результат
    result = {
        "data": data_list
    }

    # Сохранение в JSON
    with open('rcs_data.json', 'w') as f:
        json.dump(result, f, indent=4)

if __name__ == "__main__":
    main()
